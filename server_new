#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <pthread.h>
#include <sys/wait.h>


typedef struct
{
    char type;
    char id[32];
    char text[128];
}msg_t;
typedef struct  node_t
{
    struct sockaddr_in caddr;
    struct node_t *next;
} list;

typedef struct 
{
    int sockfd;
    list *head;
}thread_args_t;
struct sockaddr_in saddr,caddr;
pthread_mutex_t list_mutex;
void *handler(void *arg);

list *listcreat(void);
void login(int sockfd,msg_t msg,list *p,struct sockaddr_in caddr);
void chat(int sockfd,msg_t msg,list *p,struct sockaddr_in caddr);
void quit(int sockfd,msg_t msg,list *p,struct sockaddr_in caddr);

int main(int argc,char const* argv[])
{
    if(argc!=2){
        printf("usage: bluablua");
        return -1;
    }
    int sockfd;
    socklen_t len=sizeof(caddr);
    msg_t msg;
    
    sockfd=socket(AF_INET,SOCK_DGRAM,0);
    if(sockfd<0){
        perror("socket errot");
        return -1;
    }

    //端口复用
    int opt=1;
    if(setsockopt(sockfd,SOL_SOCKET,SO_REUSEADDR,&opt,sizeof(opt))<0)
    {
        perror("setsock");
        close(sockfd);
        return -1;
    }
    printf("Sever bind Port:%s\n",argv[1]);

    list *head = list_create();
    if(head==NULL)
    {
        close(sockfd);
        return -1;
    }
    if(pthread_mutex_init(&list_mutex,NULL)!=0){
        perror("mutex init error");
        close(sockfd);
        return -1;
    }
   
    thread_args_t *args=malloc(sizeof(thread_args_t));
    if(args==NULL){
        perror("mallol error");
        close(sockfd);
        return -1;
    }
    args->sockfd=sockfd;
    args->head=head;
    pthread_t tid;
    if(pthread_create(&tid,NULL,handler,args)!=0){
        perror("pthread error");
        close(sockfd);
        free(args);
        return -1;
    }
    pthread_detach(tid);
    while(1){
        memset(&msg,0,sizeof(msg));
        memset()
    }
}
